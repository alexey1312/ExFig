amends "package://github.com/jdx/hk/releases/download/v1.27.0/hk@1.27.0#/Config.pkl"
import "package://github.com/jdx/hk/releases/download/v1.27.0/hk@1.27.0#/Builtins.pkl"

// =============================================================================
// hk Configuration for ExFig
// =============================================================================
// Migrated from pre-commit
// All hooks run in parallel for maximum performance
// =============================================================================

// Excludes for generated/binary files
local generated_excludes = List(".build/**", "docs/**", "CHANGELOG.md")

// Excludes for template files (stencil templates require specific formatting)
local template_excludes = List("**/*.stencil", "**/*.stencil.include")

// =============================================================================
// Swift Linters (parallel, check_first optimization)
// =============================================================================

local swift_linters = new Mapping<String, Step> {
    ["swiftformat"] {
        glob = List("*.swift")
        check = "swiftformat --lint {{files}}"
        fix = "swiftformat {{files}}"
        batch = true
        stage = List("*.swift")
        check_first = true
        output_summary = "hide"
    }
    ["swiftlint"] {
        glob = List("*.swift")
        check = "swiftlint lint --strict --quiet {{files}}"
        fix = "swiftlint --fix {{files}}"
        batch = true
        output_summary = "hide"
    }
    // Full project swiftlint check (catches issues in unchanged files affected by changes)
    ["swiftlint-all"] {
        glob = List("*.swift")
        check = "swiftlint lint --strict --quiet"
        batch = true
        output_summary = "hide"
    }
}

// =============================================================================
// dprint Formatter (Markdown) - Rust-based, fast
// =============================================================================

local dprint_checks = new Mapping<String, Step> {
    ["dprint"] {
        glob = List("*.md")
        exclude = List("CHANGELOG.md", "Sources/**/*.docc/**", ".claude/**", ".github/ISSUE_TEMPLATE/**")
        check = "dprint check {{files}}"
        fix = "dprint fmt {{files}}"
        stage = List("*.md")
        batch = true
        check_first = true
        output_summary = "hide"
    }
}

// =============================================================================
// Builtin Checks (fast, parallel)
// =============================================================================

local builtin_checks = new Mapping<String, Step> {
    ["trailing-whitespace"] = (Builtins.trailing_whitespace) {
        exclude = generated_excludes + template_excludes
        hide = true
    }
    ["check-merge-conflict"] = (Builtins.check_merge_conflict) {
        hide = true
    }
    ["newlines"] = (Builtins.newlines) {
        exclude = generated_excludes + template_excludes
        hide = true
    }
}

// =============================================================================
// Combined Linters
// =============================================================================

local all_linters = new Mapping<String, Step> {
    ...swift_linters
    ...dprint_checks
    ...builtin_checks
}

// =============================================================================
// Hooks Configuration
// =============================================================================

hooks {
    // Pre-commit: runs all linters with auto-fix
    ["pre-commit"] {
        fix = true
        stash = "git"
        steps = all_linters
    }

    // Commit-msg: validate conventional commits format
    ["commit-msg"] {
        steps {
            ["conventional-commit"] = Builtins.check_conventional_commit
        }
    }

    // Helper: run all linters with fix
    ["fix"] {
        fix = true
        steps = all_linters
    }

    // Helper: run all linters without fix
    ["check"] {
        steps = all_linters
    }
}
