# =============================================================================
# mise Configuration for ExFig
# =============================================================================
# This file defines project tools, tasks, and environment variables.
#
# Bootstrap Binary Version Management:
# ------------------------------------
# The mise version for this project is embedded in ./bin/mise bootstrap binary.
# NO global mise installation required - ./bin/mise is self-contained!
#
# To update mise version:
#   1. Regenerate bootstrap: mise generate bootstrap > ./bin/mise
#   2. Make executable: chmod +x ./bin/mise
# =============================================================================

[settings]
lockfile = true
experimental = true
legacy_version_file = false

# =============================================================================
# Tools
# =============================================================================

[tools]
# --- Swift Development ---
swiftformat = "0.58.7" # Swift code formatting
swiftlint = "0.62.2"   # Swift linting
xcsift = "1.0.19"      # xcodebuild output filtering

# --- Documentation & Formatting ---
dprint = "0.50.2" # MD/JSON/YAML formatting (Rust, fast)

# --- Git & CI ---
hk = "1.28.0"        # Git hooks manager
actionlint = "1.7.9" # GitHub Actions linting
git-cliff = "2.10.1" # Changelog generation

# --- Configuration ---
pkl = "0.30.2" # Configuration language (for hk.pkl)
swift = "6.2.3"

# =============================================================================
# Tasks
# =============================================================================

[tasks.build]
description = "Build the Swift package (debug)"
run = "swift build 2>&1 | xcsift -w -f toon --toon-key-folding safe"

[tasks."build:release"]
description = "Build the Swift package (release)"
run = "swift build --configuration release 2>&1 | xcsift -w -f toon --toon-key-folding safe"

[tasks.test]
description = "Run all tests"
run = "swift test 2>&1 | xcsift -w -f toon --toon-key-folding safe"

[tasks."test:filter"]
description = "Run tests with filter (usage: mise run test:filter ExFigTests)"
run = "swift test --filter {{arg(name='filter')}} 2>&1 | xcsift -w -f toon --toon-key-folding safe"

[tasks."test:file"]
description = "Run tests for a specific file (usage: mise run test:file Tests/SVGKitTests/SVGParserTests.swift)"
run = """
#!/bin/bash
TEST_CLASS=$(basename "{{arg(name='file')}}" .swift)
swift test --filter "$TEST_CLASS" 2>&1 | xcsift -w -f toon --toon-key-folding safe
"""

[tasks.lint]
description = "Run SwiftLint and actionlint"
run = """
swiftlint lint --strict Sources Tests 2>&1 | xcsift -f toon --toon-key-folding safe
actionlint
"""

[tasks."format:swift"]
description = "Format Swift code"
run = "swiftformat Sources Tests"

[tasks."format-check:swift"]
description = "Check code formatting (CI)"
run = "swiftformat Sources Tests --lint"

[tasks."format:md"]
description = "Format markdown files"
run = "dprint fmt"

[tasks."format-check:md"]
description = "Check markdown formatting (CI)"
run = "dprint check"

[tasks.format]
description = "Format all files (Swift + Markdown)"
run = "hk fix --all 2>&1 | grep -E '^(✔|✗|hk )' || true"

[tasks.format-check]
description = "Check all formatting (CI)"
run = """
set -o pipefail
hk check --all 2>&1 | grep -E '^(✔|✗|hk )'
"""

[tasks.setup]
description = "Install git hooks (hk)"
run = "./Scripts/install-hooks.sh"

[tasks.pre-commit]
description = "Run all pre-commit checks"
run = """
set -o pipefail
hk check --all 2>&1 | grep -E '^(✔|✗|hk )'
"""

[tasks.docs]
description = "Generate DocC documentation"
run = """
swift package --allow-writing-to-directory docs \
    generate-documentation --target ExFig \
    --disable-indexing \
    --transform-for-static-hosting \
    --hosting-base-path ExFig \
    --output-path docs
echo '<script>window.location.href += "/documentation/exfig"</script>' > docs/index.html
"""

[tasks."docs:preview"]
description = "Generate and preview DocC documentation"
run = """
swift package --disable-sandbox preview-documentation --target ExFig
"""

[tasks.clean]
description = "Clean build artifacts"
run = "swift package clean && rm -rf .build"

[tasks."clean:all"]
description = "Clean all caches (SPM, DerivedData, build)"
run = """
#!/bin/bash
echo "Cleaning SPM caches..."
rm -rf ~/Library/Caches/org.swift.swiftpm
rm -rf ~/Library/org.swift.swiftpm
rm -rf ~/.swiftpm
rm -rf .build
rm -f Package.resolved
swift package purge-cache 2>/dev/null || true

echo "Cleaning DerivedData..."
rm -rf ~/Library/Developer/Xcode/DerivedData

echo "✓ All caches cleaned"
"""

[tasks.changelog]
description = "Generate CHANGELOG.md from git history"
run = "git-cliff -o CHANGELOG.md"

[tasks."changelog:unreleased"]
description = "Preview unreleased changes"
run = "git-cliff --unreleased"

[tasks.coverage]
description = "Run tests, show coverage report, and update README badge"
run = "./Scripts/coverage.sh --run-tests --update-badge"
