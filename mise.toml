# =============================================================================
# mise Configuration for ExFig
# =============================================================================
# This file defines project tools, tasks, and environment variables.
#
# Bootstrap Binary Version Management:
# ------------------------------------
# The mise version for this project is embedded in ./bin/mise bootstrap binary.
# NO global mise installation required - ./bin/mise is self-contained!
#
# To update mise version:
#   Option 1 (Recommended): bin/mise self-update
#
#   Option 2 (Manual regeneration):
#     1. Install new mise temporarily: curl https://mise.run | sh
#     2. Regenerate bootstrap: mise generate bootstrap > ./bin/mise
#     3. Make executable: chmod +x ./bin/mise
# =============================================================================

[settings]
lockfile = false
experimental = true
legacy_version_file = false

# =============================================================================
# Tools
# =============================================================================

[tools]
python = "3.13"
pre-commit = "4.5.0"
swiftformat = "0.58.7"
swiftlint = "0.62.2"
xcsift = "1.0.14"
"pipx:mdformat" = "0.7.22"

# =============================================================================
# Tasks
# =============================================================================

[tasks.build]
description = "Build the Swift package (debug)"
run = "swift build 2>&1 | xcsift -w -f toon --toon-key-folding safe"

[tasks."build:release"]
description = "Build the Swift package (release)"
run = "swift build -c release 2>&1 | xcsift -w -f toon --toon-key-folding safe"

[tasks.test]
description = "Run all tests"
run = "swift test 2>&1 | xcsift -w -f toon --toon-key-folding safe"

[tasks."test:filter"]
description = "Run tests with filter (usage: mise run test:filter ExFigTests)"
run = "swift test --filter {{arg(name='filter')}} 2>&1 | xcsift -w -f toon --toon-key-folding safe"

[tasks.lint]
description = "Run SwiftLint"
run = "swiftlint lint --strict Sources Tests 2>&1 | xcsift -f toon --toon-key-folding safe"

[tasks.format]
description = "Format code with SwiftFormat"
run = "swiftformat Sources Tests"

[tasks.format-check]
description = "Check code formatting (CI)"
run = "swiftformat Sources Tests --lint"

[tasks.setup]
description = "Install tools and configure pre-commit hooks"
run = """
# Install mdformat plugins via uv tool install
uv tool install --force mdformat==0.7.22 --with mdformat-gfm --with mdformat-tables --with mdformat-frontmatter --with mdformat-footnote 2>&1

# Install pre-commit hooks
pre-commit install
"""

[tasks.pre-commit]
description = "Run pre-commit on all files"
run = "pre-commit run --all-files"

[tasks.format-md]
description = "Format markdown files"
run = """
echo "üîç Finding markdown files..."
MD_FILES=$(find . -name '*.md' -not -path '*/.build/*' -not -path '*/.git/*' | wc -l | tr -d ' ')
echo "üìù Formatting $MD_FILES markdown file(s)..."
find . -name '*.md' \
  -not -path '*/.build/*' \
  -not -path '*/.git/*' \
  -exec mdformat --wrap 120 --number {} + && \
  echo "‚úÖ Successfully formatted $MD_FILES markdown file(s)" || \
  echo "‚ö†Ô∏è  Some markdown files could not be formatted"
"""

[tasks.format-md-check]
description = "Check markdown formatting (CI)"
run = """
echo "üîç Checking markdown formatting..."
MD_FILES=$(find . -name '*.md' -not -path '*/.build/*' -not -path '*/.git/*' | wc -l | tr -d ' ')
echo "üìù Checking $MD_FILES markdown file(s)..."
if find . -name '*.md' -not -path '*/.build/*' -not -path '*/.git/*' -exec mdformat --check --wrap 120 --number {} +; then
  echo "‚úÖ All markdown files are properly formatted"
else
  echo "‚ùå Some markdown files need formatting. Run: mise run format-md"
  exit 1
fi
"""
