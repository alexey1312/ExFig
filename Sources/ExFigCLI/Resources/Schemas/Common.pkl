/// Common types and configurations shared across all platforms.
module Common

import "Figma.pkl"

// MARK: - Enums

/// Naming style for generated code identifiers.
typealias NameStyle = "camelCase"|"snake_case"|"PascalCase"|"flatCase"|"kebab-case"|"SCREAMING_SNAKE_CASE"

/// Vector format for icons.
typealias VectorFormat = "pdf"|"svg"

/// Source format for fetching images from Figma API.
/// - `png`: Download raster PNG from Figma (default, legacy behavior)
/// - `svg`: Download SVG and rasterize locally with resvg (higher quality)
typealias SourceFormat = "png"|"svg"

// MARK: - WebP Options

/// WebP encoding mode.
typealias WebpEncoding = "lossy"|"lossless"

/// WebP encoding options.
class WebpOptions {
  /// Encoding mode.
  encoding: WebpEncoding = "lossy"

  /// Quality for lossy encoding (0-100).
  quality: Int(isBetween(0, 100))?
}

// MARK: - Tokens File Source

/// Local W3C DTCG .tokens.json file source.
/// When set on a colors entry, bypasses Figma API and reads tokens from a local file.
class TokensFile {
  /// Path to the .tokens.json file.
  path: String(isNotEmpty)

  /// Optional dot-path prefix to filter tokens (e.g., "Brand.Colors").
  groupFilter: String?
}

// MARK: - Cache

/// Cache configuration for tracking Figma file versions.
class Cache {
  /// Enable version tracking cache.
  enabled: Boolean? = false

  /// Custom path to cache file.
  path: String? = ".exfig-cache.json"
}

// MARK: - Name Processing

/// Name validation and transformation configuration.
open class NameProcessing {
  /// Regex pattern for validating/capturing names.
  nameValidateRegexp: String?

  /// Replacement pattern using captured groups.
  nameReplaceRegexp: String?
}

// MARK: - Source Configuration

/// Figma Variables source configuration.
/// Used for colors that come from Figma Variables API.
/// All fields are optional to support legacy format where source comes from common.variablesColors.
open class VariablesSource extends NameProcessing {
  /// Local .tokens.json file source (bypasses Figma API when set).
  tokensFile: TokensFile?

  /// Figma file ID containing the variables.
  tokensFileId: String?

  /// Name of the variable collection.
  tokensCollectionName: String?

  /// Mode name for light theme.
  lightModeName: String?

  /// Mode name for dark theme.
  darkModeName: String?

  /// Mode name for light high contrast theme.
  lightHCModeName: String?

  /// Mode name for dark high contrast theme.
  darkHCModeName: String?

  /// Mode name for primitives/aliases layer.
  primitivesModeName: String?
}

/// Figma Frame source configuration.
/// Used for icons and images that come from Figma frames.
open class FrameSource extends NameProcessing {
  /// Figma frame name to export from.
  figmaFrameName: String?

  /// Figma page name to filter components by.
  /// When set, only components from this specific page are exported.
  /// Useful when multiple pages have frames with the same name.
  figmaPageName: String?

  /// Override Figma file ID for this specific entry.
  /// When set, overrides the global `figma.lightFileId` for loading data.
  figmaFileId: String?

  /// Figma component property name for RTL variant detection.
  /// When set, components in a COMPONENT_SET with this variant property
  /// have their RTL=Off variant exported with RTL metadata (isRTL flag).
  /// RTL=On variants are automatically skipped â€” the base variant is
  /// mirrored at runtime by the platform (iOS languageDirection, Android autoMirrored).
  /// Set to null to disable variant-based RTL detection.
  rtlProperty: String? = "RTL"
}

// MARK: - Common Settings

/// Common colors settings shared across platforms.
class Colors extends NameProcessing {
  /// Use single file for all color modes.
  useSingleFile: Boolean?

  /// Suffix for dark mode colors.
  darkModeSuffix: String?

  /// Suffix for light high contrast colors.
  lightHCModeSuffix: String?

  /// Suffix for dark high contrast colors.
  darkHCModeSuffix: String?
}

/// Common icons settings shared across platforms.
class Icons extends NameProcessing {
  /// Figma frame name containing icons.
  figmaFrameName: String?

  /// Figma page name to filter icons by.
  figmaPageName: String?

  /// Use single file for all icon modes.
  useSingleFile: Boolean?

  /// Suffix for dark mode icons.
  darkModeSuffix: String?

  /// If true, exit with error when pathData exceeds 32,767 bytes (AAPT limit).
  strictPathValidation: Boolean?
}

/// Common images settings shared across platforms.
class Images extends NameProcessing {
  /// Figma frame name containing images.
  figmaFrameName: String?

  /// Figma page name to filter images by.
  figmaPageName: String?

  /// Use single file for all image modes.
  useSingleFile: Boolean?

  /// Suffix for dark mode images.
  darkModeSuffix: String?
}

/// Common typography settings shared across platforms.
class Typography extends NameProcessing {
}

/// Common Figma Variables colors source (required fields version).
/// Used when all platforms share the same color source via common.variablesColors.
class VariablesColors extends NameProcessing {
  /// Figma file ID containing the variables (required).
  tokensFileId: String(isNotEmpty)

  /// Name of the variable collection (required).
  tokensCollectionName: String(isNotEmpty)

  /// Mode name for light theme (required).
  lightModeName: String(isNotEmpty)

  /// Mode name for dark theme.
  darkModeName: String?

  /// Mode name for light high contrast theme.
  lightHCModeName: String?

  /// Mode name for dark high contrast theme.
  darkHCModeName: String?

  /// Mode name for primitives/aliases layer.
  primitivesModeName: String?
}

/// Root common configuration.
class CommonConfig {
  /// Cache configuration.
  cache: Cache?

  /// Common colors settings.
  colors: Colors?

  /// Shared Figma Variables source for colors.
  /// Used when all platforms use the same color source.
  variablesColors: VariablesColors?

  /// Common icons settings.
  icons: Icons?

  /// Common images settings.
  images: Images?

  /// Common typography settings.
  typography: Typography?
}
